{% if not is_pjax %}
  {% extends "./layout/layout.html" %}
{% endif %}
{% block page_content %}
<ol class="breadcrumb">
  <li>
    <a data-pjax href="/">Home</a>
  </li>
  <li><a data-pjax href="/project/{{task.project.id}}">{{task.project.name}}</a></li>
  <li class="active">{{task.name}}</li>
  <button type="button" class="btn btn-primary btn-xs pull-right" onclick="toUploadFile()">上传附件</button>
  <input type="file" class="hidden" id="uploadFileInput" multiple onchange="uploadFile()"/>
</ol>

<div id="task_detail_div"></div>
<div id="task_attachment_div"></div>
<div id="task_dynamic_div"></div>
<input type="text" id="content" data-task-id="{{task.id}}" onkeypress="sendTaskMessage(event)" class="form-control" placeholder="type something..."/>

{% endblock %}
{% block page_js %}
  <script>
    $('.spinner').show();
    setTimeout(function() {
      ws.emit('data', { code: 909, detail: { taskId: {{task.id}} } });
    }, 500);

    function toUploadFile() {
      $("#uploadFileInput").click();
    }

    function uploadFile() {
      let files = document.getElementById('uploadFileInput').files;
      let fd = new FormData();
      fd.append('files', files);
      $.post({
        url: "/uploadFile",
        data: fd,
        dataType: 'json',
        processData: false,
        contentType: false,
        success: function (data) {
          if (data.code === 200) {
            console.log(data);
          } else {
            alert(data.description);
          }
        }
      })
    }
  </script>
{% endblock %}